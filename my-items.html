<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Meine Items ‚Äì Lootliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --gold:#f5c451;
  --border:#2a2a2a;
  --green:#4cff4c;
  --yellow:#f0e68c;
  --blue:#6fa8ff;
  --red:#ff6b6b;
  --orange:#ffb347;
}
*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(ellipse at top,#181818 0%,#090909 65%);
  color:#eaeaea;
}

.wrapper{max-width:1600px;margin:0 auto}

/* ===== HERO ===== */
.hero{
  background:url("img/banner_diablo.png") center top / cover no-repeat;
  border-radius:0 0 26px 26px;
  overflow:hidden;
  min-height:180px;
}
.hero-inner{
  padding:32px 36px 28px;
  background:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.7));
}
.hero h1{margin:0;font-size:32px;font-weight:700}
.hero p{margin:8px 0 0;opacity:.8}

/* AUTH BOX */
.auth-box{
  position:absolute;
  top:22px;
  right:24px;
  display:flex;
  gap:10px;
  align-items:center;
  padding:10px 14px;
  border:1px solid var(--border);
  border-radius:14px;
  background:rgba(0,0,0,.5);
  font-size:13px;
}
.auth-box img{width:26px;height:26px;border-radius:50%}
.auth-link{font-size:12px;color:var(--gold);text-decoration:none;opacity:.85}
.auth-link:hover{text-decoration:underline;opacity:1}

/* ===== CONTENT ===== */
.container{padding:34px 28px 60px}

/* ===== DASHBOARD ===== */
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
  margin-bottom:18px;
}
.stat{
  padding:16px;
  background:#121212;
  border:1px solid #222;
  border-radius:16px;
}
.stat strong{font-size:22px}
.stat small{display:block;margin-top:4px;color:#aaa;font-size:12px}

/* ===== ACTION BAR ===== */
.action-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
}

.filter-bar{display:flex;gap:10px}
select{
  padding:8px 10px;
  background:#111;
  border:1px solid #333;
  color:#fff;
  border-radius:10px;
}

.bulk-bar{font-size:12px;color:#aaa}

/* ===== TABLE ===== */
.table-wrap{
  background:#0f0f0f;
  border:1px solid #222;
  border-radius:18px;
  overflow:hidden;
}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:12px;border-bottom:1px solid #222;vertical-align:top}
th{color:#aaa;font-weight:500;text-align:left}
tr:hover{background:rgba(255,255,255,.02)}
tr.needs-action{background:rgba(255,179,71,.06)}

/* ===== BADGES ===== */
.badge{padding:4px 10px;border-radius:999px;font-size:11px;background:#111;border:1px solid #333}
.badge.green{color:var(--green)}
.badge.blue{color:var(--blue)}
.badge.orange{color:var(--orange)}

/* ===== ITEM CELL ===== */
.item-cell{display:flex;align-items:center;gap:12px}
.item-icon{
  width:42px;height:42px;border-radius:12px;
  background:#000;border:1px solid #333;
  display:flex;align-items:center;justify-content:center;
  cursor:zoom-in
}
.item-icon img{width:26px}
.item-meta strong{display:block}
.item-meta small{color:#888;font-size:12px}

/* ===== DETAILS ===== */
.detail-box{
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  background:#0f0f0f;
  border:1px dashed rgba(245,196,81,.5);
  color:#f5e6b3;
}
.kv{display:grid;grid-template-columns:110px 1fr;gap:6px 8px}
.kv span{color:#aaa}

/* ===== ACTIONS ===== */
.actions{display:flex;gap:8px;flex-wrap:wrap}
.action-btn{
  padding:6px 10px;
  font-size:12px;
  border-radius:10px;
  background:#111;
  border:1px solid #333;
  color:#ddd;
  cursor:pointer;
}
.action-btn.green{border-color:rgba(143,209,143,.6);color:#cfe9cf}
.action-btn.red{border-color:rgba(255,107,107,.6);color:#ffb3b3}
.action-btn.waiting{
  opacity:.6;
  cursor:not-allowed;
  border-color:#666;
}

/* ===== OVERLAY ===== */
#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999
}
#overlay img{max-width:90%;max-height:90%;border-radius:14px}

/* ===== PRIVATE NOTE ===== */
.note-icon{
  margin-left:6px;
  font-size:13px;
  cursor:pointer;
  opacity:.75;
}
.note-icon:hover{
  opacity:1;
}
  
</style>
</head>
<body>

<div class="wrapper">

<header class="hero">
  <div class="hero-inner">

    <div class="auth-box">
      <img src="img/avatars/default.png" alt="Avatar">
      <span id="playerName">‚Äì</span>
      <a href="index.html" class="auth-link">Lootliste</a>
      <a href="my-claims.html" class="auth-link">Meine Claims</a>
    </div>

    <h1>Meine Items</h1>
    <p>Items, die du selbst in die Lootliste eingebracht hast</p>

  </div>
</header>

<div class="container">

  <div class="dashboard">
    <div class="stat"><strong id="cAll">0</strong><small>Alle Items</small></div>
    <div class="stat"><strong id="cFree">0</strong><small>Verf√ºgbar</small></div>
    <div class="stat"><strong id="cRes">0</strong><small>Reserviert</small></div>
    <div class="stat"><strong id="cDone">0</strong><small>Abgeschlossen</small></div>
  </div>

  <div class="action-bar">
    <div class="filter-bar">
      <select id="filterStatus">
        <option value="">Status: alle</option>
        <option value="verf√ºgbar">verf√ºgbar</option>
        <option value="reserviert">reserviert</option>
        <option value="vergeben">abgeschlossen</option>
      </select>
      <select id="filterSeason">
        <option value="">Season: alle</option>
        <option value="non-ladder">non-ladder</option>
        <option value="ladder">ladder</option>
      </select>
    </div>
    <div class="bulk-bar">Reservierte Items sind hervorgehoben</div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Status</th>
          <th>Reservierung</th>
          <th>Aktionen</th>
          <th>Season</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

</div>
</div>

<div id="overlay" onclick="this.style.display='none'"><img id="overlayImg"></div>

<script>
const API = "https://lootliste-production.up.railway.app";
const accountId = localStorage.getItem("lootliste_account_id");
const deviceId  = localStorage.getItem("lootliste_user_id");

(async()=>{
  if(!accountId) return;
  const r = await fetch(API+"/me",{headers:{"X-Account-Id":accountId,"X-User-Id":deviceId||""}});
  const d = await r.json();
  if(d.username) document.getElementById("playerName").textContent=d.username;
})();

if(!accountId){
  document.body.innerHTML="<p style='padding:40px'>Nicht eingeloggt.</p>";
}

async function load(){
  const items = await fetch(API+"/items").then(r=>r.json());
  const accounts = await fetch(API+"/admin/accounts").then(r=>r.json());

  const mine = items.filter(i=>i.donorAccountId===accountId);

  let cFreeN=0,cResN=0,cDoneN=0;
  tableBody.innerHTML="";

  mine.forEach(i=>{
    const donorConfirmedUI =
      localStorage.getItem("donor_confirmed_ui_"+i.id)==="yes";

    let label="Verf√ºgbar", cls="green", needsAction=false, actionHtml="";

    if(i.status==="vergeben"){
      label="Abgeschlossen"; cls="blue"; cDoneN++;
    }
    else if(i.status==="reserviert"){
      if(donorConfirmedUI){
        label="Wartet auf Empf√§nger"; cls="blue"; cResN++;
        actionHtml=`<button class="action-btn waiting" disabled>‚è≥ Wartet auf Empf√§nger</button>`;
      }else{
        label="Reserviert"; cls="orange"; needsAction=true; cResN++;
        actionHtml=`<button class="action-btn green" onclick="confirmDone(${i.id})">‚úî √úbergabe</button>`;
      }
    }
    else{
      cFreeN++;
      actionHtml=`<button class="action-btn red" onclick="removeItem(${i.id})">üóë Entfernen</button>`;
    }

    const claimer = accounts.find(a=>a.id===i.claimedByAccountId);

const tr=document.createElement("tr");
if(needsAction) tr.classList.add("needs-action");

tr.innerHTML=`
  <td>${i.id}</td>
  <td>
    <div class="item-cell">
      <div class="item-icon" onclick="showShot('${i.screenshot||""}')">
        <img src="img/icons/${i.type||"sonstiges"}.png">
      </div>
      <div class="item-meta">
        <strong>
          ${i.name}
          <span
            class="note-icon"
            title="${i.note_private || 'Interne Notiz bearbeiten'}"
            onclick="editNote(${i.id}, '${(i.note_private || '').replace(/'/g,'&#39;')}')"
          >üìù</span>
        </strong>
        <small>${i.quality||""} ¬∑ ${i.type||""}</small>
      </div>
    </div>
  </td>
  <td><span class="badge ${cls}">${label}</span></td>
  <td>
    ${claimer?`
      <div class="detail-box">
        <div class="kv">
          <span>Spieler</span><div>${claimer.username}</div>
          <span>BattleTag</span><div>${i.contact||"‚Äì"}</div>
        </div>
      </div>
    `:"‚Äì"}
  </td>
  <td><div class="actions">${actionHtml}</div></td>
  <td>${i.season||"‚Äì"}</td>
`;
tableBody.appendChild(tr);
  });

  cAll.textContent=mine.length;
  cFree.textContent=cFreeN;
  cRes.textContent=cResN;
  cDone.textContent=cDoneN;
}

async function confirmDone(id){
  if(!confirm("Hast du das Item ingame √ºbergeben?")) return;

  await fetch(API + "/items/" + id + "/confirm-donor", {
    method: "POST",
    headers: { "X-Account-Id": accountId }
  });

  // ‚úÖ UI-Zwischenstatus (nur Anzeige)
  localStorage.setItem("donor_confirmed_ui_"+id,"yes");

  load();
}

async function removeItem(id){
  if(!confirm("Item wirklich l√∂schen?")) return;

  await fetch(API + "/items/" + id, {
    method: "DELETE",
    headers: { "X-Account-Id": accountId }
  });

  load();
}

function showShot(src){
  if(!src) return;
  overlayImg.src = src;
  overlay.style.display = "flex";
}

filterStatus.onchange = load;
filterSeason.onchange = load;

load();
</script>

</body>
</html>
