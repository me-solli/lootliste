<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Meine Items â€“ Lootliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --gold:#f5c451;
  --border:#2a2a2a;
  --green:#4cff4c;
  --yellow:#f0e68c;
  --blue:#6fa8ff;
  --red:#ff6b6b;
  --orange:#ffb347;
}
*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(ellipse at top,#181818 0%,#090909 65%);
  color:#eaeaea;
}

.wrapper{max-width:1600px;margin:0 auto;padding:28px}

/* ===== HEADER ===== */
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.page-header h1{margin:0}

/* ===== DASHBOARD ===== */
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
  margin-bottom:18px;
}
.stat{
  padding:16px;
  background:#121212;
  border:1px solid #222;
  border-radius:16px;
}
.stat strong{font-size:22px}
.stat small{display:block;margin-top:4px;color:#aaa;font-size:12px}

/* ===== ACTION BAR ===== */
.action-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
}

.filter-bar{display:flex;gap:10px}
select{
  padding:8px 10px;
  background:#111;
  border:1px solid #333;
  color:#fff;
  border-radius:10px;
}

.bulk-bar{font-size:12px;color:#aaa}

/* ===== TABLE ===== */
.table-wrap{
  background:#0f0f0f;
  border:1px solid #222;
  border-radius:18px;
  overflow:hidden;
}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:12px;border-bottom:1px solid #222;vertical-align:top}
th{color:#aaa;font-weight:500;text-align:left}

tr:hover{background:rgba(255,255,255,.02)}
tr.needs-action{background:rgba(255,179,71,.06)}

/* ===== BADGES ===== */
.badge{padding:4px 10px;border-radius:999px;font-size:11px;background:#111;border:1px solid #333}
.badge.green{color:var(--green)}
.badge.yellow{color:var(--yellow)}
.badge.blue{color:var(--blue)}
.badge.orange{color:var(--orange)}

/* ===== ITEM CELL ===== */
.item-cell{display:flex;align-items:center;gap:12px}
.item-icon{
  width:42px;height:42px;border-radius:12px;
  background:#000;border:1px solid #333;
  display:flex;align-items:center;justify-content:center;
  cursor:zoom-in
}
.item-icon img{width:26px}

.item-meta strong{display:block}
.item-meta small{color:#888;font-size:12px}

/* ===== DETAILS ===== */
.detail-stack{display:flex;flex-direction:column;gap:6px}
.detail-box{
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  background:#0f0f0f;
  border:1px dashed #333;
}
.detail-box.gold{border-color:rgba(245,196,81,.5);color:#f5e6b3}
.detail-box.blue{border-color:rgba(111,168,255,.5);color:#8fd1ff}
.detail-box.orange{border-color:rgba(255,179,71,.6);color:#ffd7a0}

.kv{display:grid;grid-template-columns:110px 1fr;gap:6px 8px}
.kv span{color:#aaa}

/* ===== ACTIONS ===== */
.actions{display:flex;gap:8px;flex-wrap:wrap}
.action-btn{
  padding:6px 10px;
  font-size:12px;
  border-radius:10px;
  background:#111;
  border:1px solid #333;
  color:#ddd;
  cursor:pointer;
}
.action-btn.green{border-color:rgba(143,209,143,.6);color:#cfe9cf}
.action-btn.red{border-color:rgba(255,107,107,.6);color:#ffb3b3}

/* ===== OVERLAY ===== */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999}
#overlay img{max-width:90%;max-height:90%;border-radius:14px}
</style>
</head>
<body>

<div class="wrapper">

  <div class="page-header">
    <h1>ðŸ“¦ Meine Items</h1>
  </div>

  <div class="dashboard">
    <div class="stat"><strong id="cAll">0</strong><small>Alle Items</small></div>
    <div class="stat"><strong id="cFree">0</strong><small>VerfÃ¼gbar</small></div>
    <div class="stat"><strong id="cRes">0</strong><small>Reserviert Â· Aktion nÃ¶tig</small></div>
    <div class="stat"><strong id="cDone">0</strong><small>Abgeschlossen</small></div>
  </div>

  <div class="action-bar">
    <div class="filter-bar">
      <select id="filterStatus">
        <option value="">Status: alle</option>
        <option value="verfÃ¼gbar">verfÃ¼gbar</option>
        <option value="reserviert">reserviert</option>
        <option value="vergeben">abgeschlossen</option>
      </select>
      <select id="filterSeason">
        <option value="">Season: alle</option>
        <option value="non-ladder">non-ladder</option>
        <option value="ladder">ladder</option>
      </select>
    </div>
    <div class="bulk-bar">Reservierte Items sind hervorgehoben Â· Aktion erforderlich</div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Status</th>
          <th>Reservierung</th>
          <th>Aktionen</th>
          <th>Season</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

</div>

<div id="overlay" onclick="this.style.display='none'"><img id="overlayImg"></div>

<script>
const API = "https://lootliste-production.up.railway.app";
const accountId = localStorage.getItem("lootliste_account_id");

if(!accountId){document.body.innerHTML="<p style='padding:40px'>Nicht eingeloggt.</p>"}

function isDone(i){
  return i.status==="vergeben" || localStorage.getItem("handover_confirmed_"+i.id)==="yes";
}

async function load(){
  const items = await fetch(API+"/items").then(r=>r.json());
  const accounts = await fetch(API+"/admin/accounts").then(r=>r.json());

  const mine = items.filter(i=>i.donorAccountId===accountId);
  const list = mine.map(i=>({ ...i, phase:isDone(i)?"vergeben":i.status }));

  cAll.textContent=list.length;
  cFree.textContent=list.filter(i=>i.phase==="verfÃ¼gbar").length;
  cRes.textContent=list.filter(i=>i.phase==="reserviert").length;
  cDone.textContent=list.filter(i=>i.phase==="vergeben").length;

  render(list, accounts);
}

function render(list, accounts){
  tableBody.innerHTML="";
  const fs=filterStatus.value;
  const fse=filterSeason.value;

  list
    .filter(i=>(!fs||i.phase===fs)&&(!fse||i.season===fse))
    .sort((a,b)=>a.phase==="reserviert"?-1:1)
    .forEach(i=>{
      const claimer = accounts.find(a=>a.id===i.claimedByAccountId);
      const needsAction = i.phase==="reserviert" && !isDone(i);

      const tr=document.createElement("tr");
      if(needsAction) tr.classList.add("needs-action");

      tr.innerHTML=`
        <td>${i.id}</td>
        <td>
          <div class="item-cell">
            <div class="item-icon" onclick="showShot('${i.screenshot||""}')">
              <img src="img/icons/${i.type||"sonstiges"}.png">
            </div>
            <div class="item-meta">
              <strong>${i.name}</strong>
              <small>${i.quality||""} Â· ${i.type||""}</small>
            </div>
          </div>
        </td>
        <td>
          <span class="badge ${i.phase==="vergeben"?"blue":i.phase==="verfÃ¼gbar"?"green":"orange"}">${i.phase}</span>
          ${needsAction?"<div style='margin-top:4px;font-size:11px;color:var(--orange)'>âš  Aktion nÃ¶tig</div>":""}
        </td>
        <td>
          ${i.phase==="reserviert"&&claimer?`
            <div class="detail-box gold">
              <div class="kv">
                <span>Spieler</span><div>${claimer.username}</div>
                <span>BattleTag</span><div>${i.contact||"â€“"}</div>
              </div>
            </div>
          `:""}
        </td>
        <td>
          <div class="actions">
            ${needsAction?`<button class="action-btn green" onclick="confirmDone(${i.id})">âœ” Ãœbergabe</button>`:""}
            ${i.phase==="verfÃ¼gbar"?`<button class="action-btn red" onclick="removeItem(${i.id})">ðŸ—‘ Entfernen</button>`:""}
          </div>
        </td>
        <td>${i.season||"â€“"}</td>
      `;

      tableBody.appendChild(tr);
    });
}

function confirmDone(id){
  if(confirm("Hast du das Item ingame Ã¼bergeben?")){
    localStorage.setItem("handover_confirmed_"+id,"yes");
    location.reload();
  }
}

async function removeItem(id){
  if(!confirm("Item wirklich lÃ¶schen?")) return;
  await fetch(API+"/items/"+id,{method:"DELETE",headers:{"X-Account-Id":accountId}});
  load();
}

function showShot(src){if(!src)return;overlayImg.src=src;overlay.style.display="flex"}

filterStatus.onchange=load;
filterSeason.onchange=load;

load();
</script>

</body>
</html>
