<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Meine Items ‚Äì Lootliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --gold:#f5c451;
  --border:#2a2a2a;
  --green:#4cff4c;
  --yellow:#f0e68c;
  --blue:#6fa8ff;
}
*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(ellipse at top,#181818 0%,#090909 65%);
  color:#eaeaea;
}

.wrapper{max-width:1500px;margin:0 auto;padding:28px}

/* ===== HEADER ===== */
.page-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:18px;
}
.page-header h1{margin:0}

/* ===== DASHBOARD ===== */
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:14px;
  margin-bottom:16px;
}
.stat{
  padding:14px;
  background:#121212;
  border:1px solid #222;
  border-radius:14px;
}
.stat strong{font-size:20px}

/* ===== FILTER ===== */
.filter-bar{
  display:flex;
  gap:10px;
  margin-bottom:12px;
}
select{
  padding:8px 10px;
  background:#111;
  border:1px solid #333;
  color:#fff;
  border-radius:10px;
}

/* ===== TABLE ===== */
.table-wrap{
  background:#0f0f0f;
  border:1px solid #222;
  border-radius:18px;
  overflow:hidden;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #222;
  vertical-align:top;
}
th{color:#aaa;font-weight:500}

/* ===== BADGES ===== */
.badge{
  padding:3px 8px;
  border-radius:999px;
  font-size:11px;
  background:#111;
  border:1px solid #333;
}
.badge.green{color:var(--green)}
.badge.yellow{color:var(--yellow)}
.badge.blue{color:var(--blue)}

/* ===== ITEM CELL ===== */
.item-cell{display:flex;align-items:center;gap:12px}
.item-icon{
  width:40px;height:40px;border-radius:10px;
  background:#000;border:1px solid #333;
  display:flex;align-items:center;justify-content:center;
  cursor:zoom-in
}
.item-icon img{width:26px}

/* ===== DETAILS ===== */
.detail-box{
  margin-top:6px;
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  background:#0f0f0f;
  border:1px dashed #333;
}
.detail-box.gold{border-color:rgba(245,196,81,.5);color:#f5e6b3}
.detail-box.blue{border-color:rgba(111,168,255,.5);color:#8fd1ff}

.confirm-btn{
  margin-top:6px;
  padding:6px 10px;
  font-size:12px;
  border-radius:10px;
  border:1px solid rgba(143,209,143,.6);
  background:#0f1a0f;
  color:#cfe9cf;
  cursor:pointer;
}

/* ===== OVERLAY ===== */
#overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.85);
  display:none;align-items:center;justify-content:center;
  z-index:9999
}
#overlay img{max-width:90%;max-height:90%;border-radius:14px}
</style>
</head>
<body>

<div class="wrapper">

  <div class="page-header">
    <h1>üì¶ Meine Items</h1>
  </div>

  <div class="dashboard">
    <div class="stat"><strong id="cAll">0</strong><br>Items</div>
    <div class="stat"><strong id="cFree">0</strong><br>verf√ºgbar</div>
    <div class="stat"><strong id="cRes">0</strong><br>reserviert</div>
    <div class="stat"><strong id="cDone">0</strong><br>abgeschlossen</div>
  </div>

  <div class="filter-bar">
    <select id="filterStatus">
      <option value="">Status: alle</option>
      <option value="verf√ºgbar">verf√ºgbar</option>
      <option value="reserviert">reserviert</option>
      <option value="vergeben">abgeschlossen</option>
    </select>
    <select id="filterSeason">
      <option value="">Season: alle</option>
      <option value="non-ladder">non-ladder</option>
      <option value="ladder">ladder</option>
    </select>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Status</th>
          <th>Details</th>
          <th>Season</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

</div>

<div id="overlay" onclick="this.style.display='none'"><img id="overlayImg"></div>

<script>
const API = "https://lootliste-production.up.railway.app";
const accountId = localStorage.getItem("lootliste_account_id");

if(!accountId){
  document.body.innerHTML="<p style='padding:40px'>Nicht eingeloggt.</p>";
}

function isDone(i){
  return i.status === "vergeben" ||
    i.handover?.donorConfirmed ||
    localStorage.getItem("handover_confirmed_"+i.id)==="yes";
}

async function load(){
  const items = await fetch(API+"/items").then(r=>r.json());
  const accounts = await fetch(API+"/admin/accounts").then(r=>r.json());

  const mine = items.filter(i=>i.donorAccountId===accountId);

  const list = mine.map(i=>({ ...i, phase: isDone(i)?"vergeben":i.status }));

  cAll.textContent=list.length;
  cFree.textContent=list.filter(i=>i.phase==="verf√ºgbar").length;
  cRes.textContent=list.filter(i=>i.phase==="reserviert").length;
  cDone.textContent=list.filter(i=>i.phase==="vergeben").length;

  render(list, accounts);
}

function render(list, accounts){
  tableBody.innerHTML="";
  const fs=filterStatus.value;
  const fse=filterSeason.value;

  list.filter(i=>(!fs||i.phase===fs)&&(!fse||i.season===fse))
  .forEach(i=>{
    const claimer = accounts.find(a=>a.id===i.claimedByAccountId);
    const tr=document.createElement("tr");

    tr.innerHTML=`
      <td>${i.id}</td>
      <td>
        <div class="item-cell">
          <div class="item-icon" onclick="showShot('${i.screenshot||""}')">
            <img src="img/icons/${i.type||"sonstiges"}.png">
          </div>
          <strong>${i.name}</strong>
        </div>
      </td>
      <td><span class="badge ${i.phase==="vergeben"?"blue":i.phase==="verf√ºgbar"?"green":"yellow"}">${i.phase}</span></td>
      <td>
        ${i.note_private?`<div class="detail-box"><strong>üìù Notiz</strong><br>${i.note_private}</div>`:""}
        ${i.phase==="reserviert"&&claimer?`<div class="detail-box gold"><strong>Reserviert von:</strong> ${claimer.username}<br>${i.contact||""}</div>`:""}
        ${i.phase==="reserviert"&&!isDone(i)?`<div class="detail-box blue">‚è≥ Warte auf Best√§tigung des Empf√§ngers</div>`:""}
        ${isDone(i)&&!i.handover?.donorConfirmed?`<button class="confirm-btn" onclick="confirmDone(${i.id})">‚úî √úbergabe best√§tigt</button>`:""}
      </td>
      <td>${i.season||"‚Äì"}</td>
    `;
    tableBody.appendChild(tr);
  });
}

function confirmDone(id){
  if(confirm("Hast du das Item ingame √ºbergeben?")){
    localStorage.setItem("handover_confirmed_"+id,"yes");
    location.reload();
  }
}

function showShot(src){
  if(!src) return;
  overlayImg.src=src;
  overlay.style.display="flex";
}

filterStatus.onchange=load;
filterSeason.onchange=load;

load();
</script>

</body>
</html>
