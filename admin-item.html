<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Admin ‚Äì Item verwalten</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#0f0f0f;
  color:#eee;
}
header{
  background:#141414;
  padding:16px;
  font-size:18px;
  font-weight:bold;
  border-bottom:1px solid #222;
}
main{
  max-width:900px;
  margin:30px auto;
  padding:0 20px;
}
.card{
  background:#181818;
  border:1px solid #2a2a2a;
  border-radius:10px;
  padding:22px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
}
.screenshot{
  background:#000;
  border:1px solid #333;
  border-radius:8px;
  padding:10px;
  text-align:center;
}
.screenshot img{
  max-width:100%;
  border-radius:6px;
}
.form-group{
  display:flex;
  flex-direction:column;
  margin-bottom:14px;
}
label{
  font-size:13px;
  margin-bottom:4px;
  color:#aaa;
}
input, select{
  background:#101010;
  border:1px solid #333;
  border-radius:6px;
  padding:9px;
  color:#eee;
}
.stars{
  display:flex;
  gap:6px;
  font-size:22px;
  cursor:pointer;
}
.stars span{ color:#444; }
.stars span.active{ color:gold; }
.visibility{
  margin:16px 0;
}
.visibility button{
  margin-right:10px;
  padding:8px 14px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  background:#333;
  color:#eee;
}
.visibility button.active{ background:#2e7d32; }
.visibility button.disabled{
  opacity:0.4;
  cursor:not-allowed;
}
.notice{ margin-top:14px; font-size:14px; }
.error{ color:#ff5c5c; }
.success{ color:#4cff4c; }
</style>
</head>

<body>

<header>üõ†Ô∏è Admin ‚Äì Item verwalten</header>

<main>
  <div class="card">

    <div class="screenshot">
      <img id="screenshotImg" src="" alt="Item Screenshot">
    </div>

    <div>

      <div class="visibility">
        <label>Sichtbarkeit</label><br>
        <button id="btnPublic">üîì √ñffentlich</button>
        <button id="btnPrivate">üîí Intern</button>
      </div>

      <div class="form-group">
        <label>Item-Name</label>
        <input type="text" id="name">
      </div>

      <div class="form-group">
        <label>Qualit√§t</label>
        <select id="quality">
          <option value="">Bitte w√§hlen</option>
          <option value="unique">Unique</option>
          <option value="set">Set</option>
          <option value="rare">Rare</option>
          <option value="magic">Magic</option>
        </select>
      </div>

      <div class="form-group">
        <label>Typ</label>
        <select id="type">
          <option value="">Bitte w√§hlen</option>
          <option value="waffe">Waffe</option>
          <option value="r√ºstung">R√ºstung</option>
          <option value="helm">Helm</option>
          <option value="schild">Schild</option>
          <option value="ring">Ring</option>
          <option value="amulett">Amulett</option>
          <option value="charm">Charm</option>
          <option value="rune">Rune</option>
          <option value="sonstiges">Sonstiges</option>
        </select>
      </div>

      <div class="form-group">
        <label>Roll / Werte</label>
        <input type="text" id="roll">
      </div>

      <div class="form-group">
        <label>Sterne-Bewertung</label>
        <div class="stars" id="stars">
          <span data-value="1">‚òÖ</span>
          <span data-value="2">‚òÖ</span>
          <span data-value="3">‚òÖ</span>
          <span data-value="4">‚òÖ</span>
          <span data-value="5">‚òÖ</span>
        </div>
      </div>

      <!-- Button bleibt type="button" -->
      <button id="approveBtn" type="button">Item freigeben</button>

      <div id="msg" class="notice"></div>
    </div>

  </div>
</main>

<script>
const API_BASE = "https://content-connection-production-ea07.up.railway.app";
const params = new URLSearchParams(window.location.search);
const itemId = params.get("id");
const msg = document.getElementById("msg");
const loginId = localStorage.getItem("loginId");

let itemStatus = "";
let isPublic = 0;
let selectedStars = 0;

/* Sterne */
document.querySelectorAll("#stars span").forEach(star => {
  star.onclick = () => {
    selectedStars = Number(star.dataset.value);
    document.querySelectorAll("#stars span")
      .forEach(s => s.classList.toggle("active", s.dataset.value <= selectedStars));
  };
});

/* Item laden */
fetch(`${API_BASE}/api/admin/items`,{
  headers:{ "x-login-id": loginId }
})
.then(r => r.json())
.then(items => {
  const item = items.find(i => String(i.id) === String(itemId));
  if (!item) throw new Error();

  document.getElementById("screenshotImg").src = API_BASE + item.screenshot;
  isPublic = item.is_public;
  itemStatus = item.status;

  updateVisibilityUI();
})
.catch(() => {
  msg.textContent = "‚ùå Item konnte nicht geladen werden.";
  msg.className = "notice error";
});

/* Sichtbarkeit UI */
function updateVisibilityUI(){
  const btnPublic = document.getElementById("btnPublic");
  const btnPrivate = document.getElementById("btnPrivate");

  btnPublic.classList.toggle("active", isPublic === 1);
  btnPrivate.classList.toggle("active", isPublic === 0);

  if (itemStatus !== "freigegeben") {
    btnPublic.classList.add("disabled");
    btnPrivate.classList.add("disabled");
    return;
  }

  btnPublic.onclick = () => setVisibility(1);
  btnPrivate.onclick = () => setVisibility(0);
}

/* Sichtbarkeit setzen */
async function setVisibility(value){
  try{
    const res = await fetch(
      `${API_BASE}/api/admin/items/${itemId}/visibility`,
      {
        method:"PATCH",
        headers:{
          "Content-Type":"application/json",
          "x-login-id": loginId
        },
        body:JSON.stringify({ is_public:value })
      }
    );
    if(!res.ok) throw new Error();
    isPublic = value;
    updateVisibilityUI();
  }catch{
    msg.textContent = "‚ùå Sichtbarkeit konnte nicht ge√§ndert werden.";
    msg.className = "notice error";
  }
}

/* Item freigeben ‚Äì ‚úÖ FIX: richtige Admin-Route */
document.getElementById("approveBtn").onclick = async () => {
  if(!selectedStars){
    msg.textContent = "‚ùå Sterne vergeben.";
    msg.className = "notice error";
    return;
  }

  const res = await fetch(
    `${API_BASE}/api/admin/items/${itemId}/approve`,
    {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-login-id": loginId
      },
      body:JSON.stringify({
        name:name.value,
        quality:quality.value,
        type:type.value,
        roll:roll.value,
        stars:selectedStars
      })
    }
  );

  if(res.ok){
    msg.textContent = "‚úî Item freigegeben.";
    msg.className = "notice success";
    setTimeout(()=>location.href="admin.html",800);
  }else{
    msg.textContent = "‚ùå Fehler beim Freigeben.";
    msg.className = "notice error";
  }
};
</script>

</body>
</html>
