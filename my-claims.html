<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Meine Claims – Lootliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --gold:#f5c451;
  --border:#2a2a2a;
  --green:#4cff4c;
  --yellow:#f0e68c;
  --blue:#6fa8ff;
  --orange:#ffb347;
}
*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(ellipse at top,#181818 0%,#090909 65%);
  color:#eaeaea;
}

.wrapper{max-width:1600px;margin:0 auto}

/* ===== HERO ===== */
.hero{
  background:url("img/banner_diablo.png") center top / cover no-repeat;
  border-radius:0 0 26px 26px;
  overflow:hidden;
  min-height:180px;
  position:relative;
}
.hero-inner{
  padding:32px 36px 28px;
  background:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.7));
}
.hero h1{margin:0;font-size:32px;font-weight:700}
.hero p{margin:8px 0 0;opacity:.8}

/* AUTH BOX */
.auth-box{
  position:absolute;
  top:22px;
  right:24px;
  display:flex;
  gap:10px;
  align-items:center;
  padding:10px 14px;
  border:1px solid var(--border);
  border-radius:14px;
  background:rgba(0,0,0,.5);
  font-size:13px;
}
.auth-box img{width:26px;height:26px;border-radius:50%}
.auth-link{font-size:12px;color:var(--gold);text-decoration:none;opacity:.85}
.auth-link:hover{text-decoration:underline;opacity:1}

/* ===== CONTENT ===== */
.container{padding:34px 28px 60px}

/* ===== DASHBOARD ===== */
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
  margin-bottom:18px;
}
.stat{
  padding:16px;
  background:#121212;
  border:1px solid #222;
  border-radius:16px;
}
.stat strong{font-size:22px}
.stat small{display:block;margin-top:4px;color:#aaa;font-size:12px}

/* ===== ACTION BAR ===== */
.action-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
}

.filter-bar{display:flex;gap:10px}
select{
  padding:8px 10px;
  background:#111;
  border:1px solid #333;
  color:#fff;
  border-radius:10px;
}

.bulk-bar{font-size:12px;color:#aaa}

/* ===== TABLE ===== */
.table-wrap{
  background:#0f0f0f;
  border:1px solid #222;
  border-radius:18px;
  overflow:hidden;
}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:12px;border-bottom:1px solid #222;vertical-align:top}
th{color:#aaa;font-weight:500;text-align:left}
tr:hover{background:rgba(255,255,255,.02)}
tr.needs-action{background:rgba(255,179,71,.06)}

/* ===== BADGES ===== */
.badge{padding:4px 10px;border-radius:999px;font-size:11px;background:#111;border:1px solid #333}
.badge.green{color:var(--green)}
.badge.blue{color:var(--blue)}
.badge.orange{color:var(--orange)}

/* ===== ITEM CELL ===== */
.item-cell{display:flex;align-items:center;gap:12px}
.item-icon{
  width:42px;height:42px;border-radius:12px;
  background:#000;border:1px solid #333;
  display:flex;align-items:center;justify-content:center;
}
.item-icon img{width:26px}
.item-meta strong{display:block}
.item-meta small{color:#888;font-size:12px}

/* ===== DETAILS ===== */
.detail-box{
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  background:#0f0f0f;
  border:1px dashed rgba(245,196,81,.5);
  color:#f5e6b3;
}
.kv{display:grid;grid-template-columns:110px 1fr;gap:6px 8px}
.kv span{color:#aaa}

/* ===== ACTIONS ===== */
.actions{display:flex;gap:8px;flex-wrap:wrap}
.action-btn{
  padding:6px 10px;
  font-size:12px;
  border-radius:10px;
  background:#111;
  border:1px solid #333;
  color:#ddd;
  cursor:pointer;
}
.action-btn.green{border-color:rgba(143,209,143,.6);color:#cfe9cf}
.action-btn.waiting{
  opacity:.6;
  cursor:not-allowed;
  border-color:#666;
}
</style>
</head>
<body>

<div class="wrapper">

<header class="hero">
  <div class="hero-inner">

    <div class="auth-box">
      <img src="img/avatars/default.png" alt="Avatar">
      <span id="playerName">–</span>
      <a href="index.html" class="auth-link">Lootliste</a>
      <a href="my-items.html" class="auth-link">Meine Items</a>
    </div>

    <h1>Meine Claims</h1>
    <p>Items, die du reserviert oder erhalten hast</p>

  </div>
</header>

<div class="container">

  <div class="dashboard">
    <div class="stat"><strong id="cAll">0</strong><small>Alle Claims</small></div>
    <div class="stat"><strong id="cRes">0</strong><small>Reserviert</small></div>
    <div class="stat"><strong id="cWait">0</strong><small>Wartet auf Spender</small></div>
    <div class="stat"><strong id="cDone">0</strong><small>Abgeschlossen</small></div>
  </div>

  <div class="action-bar">
    <div class="filter-bar">
      <select id="filterStatus">
        <option value="">Status: alle</option>
        <option value="reserviert">reserviert</option>
        <option value="wartet">wartet</option>
        <option value="vergeben">abgeschlossen</option>
      </select>
    </div>
    <div class="bulk-bar">Claims mit Aktion sind hervorgehoben</div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Status</th>
          <th>Spender</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

</div>
</div>

<script>
const API = "https://lootliste-production.up.railway.app";

// ===== AUTH (SESSION-BASED) =====
let currentUser = null;

async function initAuth() {
  const r = await fetch(API + "/me", {
    credentials: "include"
  });

  const d = await r.json();

  if (!d.loggedIn) {
    document.body.innerHTML =
      "<p style='padding:40px'>Nicht eingeloggt.</p>";
    return false;
  }

  currentUser = d;
  document.getElementById("playerName").textContent = d.username;

  return true;
}

async function load(){
  const response = await fetch(API+"/items", { credentials:"include" });
  const items = await response.json();

  const mine = items.filter(i=>i.claimedByAccountId===currentUser.accountId);

  let cResN=0,cWaitN=0,cDoneN=0;
  tableBody.innerHTML="";

  mine.forEach(i=>{
    const receiverConfirmedUI =
      localStorage.getItem("receiver_confirmed_ui_"+i.id)==="yes";

    let label="Reserviert", cls="orange", needsAction=true, actionHtml="";

    if(i.status==="vergeben"){
      label="Abgeschlossen"; cls="green"; needsAction=false; cDoneN++;
    }
    else if(receiverConfirmedUI){
      label="Wartet auf Spender"; cls="blue"; needsAction=false; cWaitN++;
      actionHtml=`<button class="action-btn waiting" disabled>⏳ Wartet auf Spender</button>`;
    }
    else{
      cResN++;
      actionHtml=`<button class="action-btn green" onclick="confirmReceive(${i.id})">✔ Item erhalten</button>`;
    }

    const tr=document.createElement("tr");
    if(needsAction) tr.classList.add("needs-action");

    tr.innerHTML=`
      <td>${i.id}</td>
      <td>
        <div class="item-cell">
          <div class="item-icon"><img src="img/icons/${i.type||"sonstiges"}.png"></div>
          <div class="item-meta"><strong>${i.name}</strong><small>${i.quality||""} · ${i.type||""}</small></div>
        </div>
      </td>
      <td><span class="badge ${cls}">${label}</span></td>
      <td>
        <div class="detail-box">
          <div class="kv">
            <span>Spieler</span><div>${i.donor||"–"}</div>
            <span>BattleTag</span><div>${i.contact||"–"}</div>
          </div>
        </div>
      </td>
      <td><div class="actions">${actionHtml}</div></td>
    `;
    tableBody.appendChild(tr);
  });

  cAll.textContent=mine.length;
  cRes.textContent=cResN;
  cWait.textContent=cWaitN;
  cDone.textContent=cDoneN;
}

async function confirmReceive(id){
  if(!confirm("Hast du das Item ingame erhalten?")) return;

  await fetch(API + "/items/" + id + "/confirm-receiver", {
    method: "POST",
    credentials:"include"
  });

  localStorage.setItem("receiver_confirmed_ui_"+id,"yes");

  load();
}

filterStatus.onchange = load;

(async () => {
  const ok = await initAuth();
  if (ok) {
    load();
  }
})();
</script>

</body>
</html>
